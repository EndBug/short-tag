"use strict";var __awaiter=this&&this.__awaiter||function(a,b,c,d){function e(a){return a instanceof c?a:new c(function(b){b(a)})}return new(c||(c=Promise))(function(c,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d["throw"](a))}catch(a){f(a)}}function i(a){a.done?c(a.value):e(a.value).then(g,h)}i((d=d.apply(a,b||[])).next())})},__importStar=this&&this.__importStar||function(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b["default"]=a,b},__importDefault=this&&this.__importDefault||function(a){return a&&a.__esModule?a:{default:a}};Object.defineProperty(exports,"__esModule",{value:!0});const core=__importStar(require("@actions/core")),github=__importStar(require("octonode")),shell=__importStar(require("shelljs")),path=__importStar(require("path")),semver_regex_1=__importDefault(require("semver-regex")),fs_1=require("fs"),token=core.getInput("token"),push=core.getInput("push"),eventFile=process.env.GITHUB_EVENT_PATH||"/github/workflow/event.json",client=github.client(token||void 0),repo=client.repo(process.env.GITHUB_REPOSITORY);(function(){return __awaiter(this,void 0,void 0,function*(){try{const a=yield readJson(eventFile),b=a.ref;if("tag"!=a.ref_type)return void core.info("No tag has been added.");core.info(`Sha: ${a.head}\nTag: ${b}`);let c="",d="";if("string"==typeof b&&semver_regex_1.default().test(b))c=(b.match(semver_regex_1.default())||[""])[0],c&&(d=c[0]);else return core.info("No tag matching the SemVer regex has been found, no tags have been created.");process.env.PARAM_MAJOR=d,process.env.PARAM_MATCH=c,process.env.GITHUB_TOKEN=token;let e=!push||"true"==push;!token?(process.env.PARAM_PUSH=void 0,e&&core.warning("You requested to push the tag, but didn't provide any token: the tags can't be pushed to the repo without one.")):process.env.PARAM_PUSH=e?"true":void 0,core.info(`Starting start script with the following parameters: [${d}, ${c}, ${process.env.PARAM_PUSH}]`),shell.exec(path.join(__dirname,"../src/tag.sh"))}catch(a){core.setFailed(a)}})})().finally(()=>{core.setFailed("Fake problem")});function readJson(a){return __awaiter(this,void 0,void 0,function*(){const b=yield new Promise((b,c)=>fs_1.readFile(a,"utf8",(a,d)=>{a?c(a):b(d)}));return JSON.parse(b)})}function getTag(a){return __awaiter(this,void 0,void 0,function*(){const b=(yield repo.tagsAsync())[0];for(let c of b)if(c.commit.sha==a)return c.name})}